{"version":3,"file":"collabwordcloud.min.js","sources":["../src/collabwordcloud.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript to handle wordcloud display.\n *\n * @package    mod_collabwordcloud\n * @copyright  2023 Reseau-Canope\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery','core/ajax','core/str'], function($,ajax,str) {\n\tvar wordclouds = [];\n\tvar delaystep = 1000;\n\tvar mindelay = 2000;\n\tvar maxdelay = 60000;\n\tvar svgminheight = 350;\n\tvar svgmaxheight = 600;\n\tvar apiurl = '';\n\tvar fill = d3.scaleOrdinal(d3.schemeCategory10);\n\t\n\tfunction showWordcloud(cmid,selector,api_url,editor){\n\t\tapiurl = api_url;\n\t\t\n\t\twordclouds[cmid] = new wordCloud(cmid,selector,$(selector).width(),$(selector).width()*0.56,editor);\n\t}\n\t\n\tclass wordCloud {\n\t\t\n\t\tconstructor(cmid, _selector, width, height, editor) {\n\t\t\n\t\t\tthis.width = width;\n\t\t\tthis.height = height>svgmaxheight?svgmaxheight:(height<svgminheight?svgminheight:height);\n\t\t\t\n\t\t\tthis.displaymod;\n\t\t\tthis.cmid = cmid;\n\t\t\tthis.selector = _selector;\n\t\t\tthis.parent = $(_selector).parent();\n\t\t\t\n\t\t\tthis.editing = editor;\n\t\t\tthis.isediting = false;\n\t\t\tthis.editingword = '';\n\t\t\t\n\t\t\tthis.simtimer;\n\t\t\tthis.resizetimer;\n\t\t\tthis.updatetimer;\n\t\t\tthis.updatedelay = mindelay;\n\t\t\tthis.lastupdate = 0;\n\t\t\tthis.words = [];\n\t\t\tthis.wordsrender = [];\n\t\t\t\n\t\t\tthis.wcwidth = $(this.selector).parents('#region-main-box').width();\n\t\t\tthis.borderwidth = this.wcwidth - $(this.selector).width();\n\t\t\t\n\t\t    this.weight = 0;\n\t\t\tthis.currentgroupid = -1;\n\t\t    \n\t\t  //Construct the word cloud's SVG element\n\t\t\tthis.svg = d3.select(this.selector).append(\"svg\")\n\t\t    \t.attr(\"width\", this.width)\n\t\t        .attr(\"height\", this.height)\n\t\t        .append(\"g\")\n\t\t        .attr(\"transform\", \"translate(\"+(this.width/2)+\",\"+(this.height/2)+\")\");\n\t\t    \n\t\t\tvar svg = this.svg;\n\t\t\t\n\t\t\tif ($('#fitem_id_word_1').length > 0){\n\t\t\t\tthis.switch_display('f');\n\t\t\t}else{\n\t\t\t\tif (this.parent.find('.wc_groupselector').length > 0) {\n\t\t\t\t\tthis.changegroup(this.parent.find('.wc_groupselector').val());\n\t\t\t\t}else{\n\t\t\t\t\tthis.changegroup(0);\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tthis.listeners();\n\t\t}\n\t\t\n\t\tlisteners () {\n\t\t\t\n\t\t\tif (this.parent.find('.wc_groupselector').length){\n\t\t\t\t\n\t\t\t\tthis.parent.find('.wc_groupselector').on('change', (function() {\n\t\t\t\t\tvar select = this.parent.find('.wc_groupselector');\n\t\t\t\t\tthis.changegroup(select.val());\n\t\t\t\t}).bind(this));\n\t\t\t}\n\n\t\t\t$( window ).resize((function() {\n\t\t\t\tif (this.displaymod=='c') {\n\t\t\t\t\tif (this.resizetimer != undefined){\n\t\t\t\t\t\tclearTimeout(this.resizetimer);\n\t\t\t\t\t}\n\t\t\t\t\tthis.resizetimer = setTimeout((this.resize).bind(this),500);\n\t\t\t\t}\n\t\t\t}).bind(this));\n\n\t\t\tif (this.editing) {\n\t\t\t\td3.select(this.selector.split(' ')[0]+' .wc_exportpng').on(\"click\",this.exportPNG.bind(this));\n\n\t\t\t\tthis.parent.on('click','.wc_exportdata',(function(){\n\t\t\t\t\tthis.exportData();\n\t\t\t\t}).bind(this));\n\t\t\t\t\n\t\t\t\tthis.parent.on('click','.wc_addword',(function(){\n\t\t\t\t\tthis.addWord(this);\n\t\t\t\t}).bind(this));\n\t\t\t\t\n\t\t\t\tthis.parent.on('keypress','input[name=wcaddword]',(function(e){\n\t\t\t\t\tvar key = e.which;\n\t\t\t\t\tif(key == 13) {\n\t\t\t\t\t\t $(this.parent).find('.wc_addword').click();\n\t\t\t\t\t\t return false;  \n\t\t\t\t    }\n\t\t\t\t}).bind(this));\n\t\t\t\t\n\t\t    \t$(this.selector).on('click', 'svg text', (function(event){\n\t\t    \t\tif (!this.isediting) {\n\t\t    \t\t\tthis.loadWordEdit($(event.target).text())\n\t\t    \t\t}\n\t\t    \t}).bind(this));\n\t\t    \t\n\t\t    \tthis.parent.on('keypress','input[name=wceditword]',(function(e){\n\t\t\t\t\tvar key = e.which;\n\t\t\t\t\tif(key == 13) {\n\t\t\t\t\t\t $(this.parent).find('.wc_updateword').click();\n\t\t\t\t\t\t return false;  \n\t\t\t\t    }\n\t\t\t\t}).bind(this));\n\t\t    \t\n\t\t    \tthis.parent.on('input','input[name=wceditword]',(function(e){\n\t\t\t\t\tif (this.isediting) {\n\t\t    \t\t\tif (this.simtimer != undefined){\n\t\t\t\t\t\t\tclearTimeout(this.resizetimer);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthis.simtimer = setTimeout((this.simUpdateWord).bind(this),500);\n\t\t    \t\t}\n\t\t\t\t}).bind(this));\n\t\t    \t\n\t\t    \t$(this.parent).on('click', '.wc_updateword', (function(event){\n\t\t    \t\tif (this.isediting) {\n\t\t    \t\t\tthis.updateWord();\n\t\t    \t\t}\n\t\t    \t}).bind(this));\n\t\t    \t\n\t\t    \t$(this.parent).on('click', '.wc_removeword', (function(event){\n\t\t    \t\tif (this.isediting) {\n\t\t    \t\t\tthis.removeWord();\n\t\t    \t\t\tthis.closeWordEdit();\n\t\t    \t\t}\n\t\t    \t}).bind(this));\n\n\t\t    \tthis.parent.on('click', '.wc_closeedit', (function(event){\n\t\t    \t\tif (this.isediting) {\n\t\t    \t\t\tthis.closeWordEdit();\n\t\t    \t\t}\n\t\t    \t}).bind(this));\n\t\t    \t\n\t\t    }\n\t\t}\n\t    \n\t    //Draw the word cloud\n\t    draw(words) {\n\t        var cloud = this.svg.selectAll(\"g text\").data(words, function(d) { return d.text; })\n\t        \n\t        //Entering words\n\t        cloud.enter()\n\t            .append(\"text\")\n\t            .style(\"font-family\", \"Impact\")\n\t            .style(\"fill\", function(d, i) { return fill(Math.random()); })\n\t            .attr(\"text-anchor\", \"middle\")\n\t            .attr('font-size', 1)\n\t            .text(function(d) { return d.text; });\n\t        \n\t        // Reload new words\n\t        cloud = this.svg.selectAll(\"g text\").data(words, function(d) { return d.text; })\n\t        \n\t        //Entering and existing words\n\t        cloud.transition()\n\t                .duration(600)\n\t                .style(\"font-size\", function(d) { return d.size + \"px\"; })\n\t                .attr(\"transform\", function(d) {\n\t                    return \"translate(\" + [d.x, d.y] + \")rotate(\" + d.rotate + \")\";\n\t                })\n\t                .style(\"fill-opacity\", 1);\n\n\t        //Exiting words\n\t        cloud.exit()\n\t            .transition()\n\t                .duration(200)\n\t                .style('fill-opacity', 1e-6)\n\t                .attr('font-size', 1)\n\t                .remove();\n\t    }\n\n        update_svg() {\n        \tthis.wordsrender = JSON.parse(JSON.stringify(this.words));\n            var cloud = d3.layout.cloud().size([this.width, this.height])\n                .words(this.wordsrender)\n                .padding(3)\n                .rotate(function() { return (~~(Math.random() * 2) * 90)-45; })\n                .font(\"Impact\")\n                .fontSize(function(d) { return d.size; })\n                .on(\"end\", this.draw.bind(this))\n                .start();\n        }\n        \n        resize(){\n        \tif (this.wcwidth != $(this.selector).parents('#region-main-box').width()) {\n        \t\tthis.wcwidth = $(this.selector).parents('#region-main-box').width();\n        \t\tthis.width = $(this.selector).parents('#region-main-box').width()-this.borderwidth;\n        \t\tthis.height = this.width*0.56;\n        \t\t\n        \t\tif (this.height > svgmaxheight) {\n        \t\t\tthis.height = svgmaxheight;\n        \t\t}else if (this.height < svgminheight) {\n        \t\t\tthis.height = svgminheight;\n        \t\t}\n\t        \t\n\t        \t$(this.selector).find(\"svg\").attr(\"width\", this.width)\n\t\t        .attr(\"height\", this.height).find(\"g\").attr(\"transform\", \"translate(\"+(this.width/2)+\",\"+(this.height/2)+\")\");;\n\t\t    \t\n\t\t        this.update_svg();\n        \t}\n\t    }\n\t    \n\t    changegroup(groupid) {\n\t\t\tif (this.currentgroupid != groupid) {\n\t\t\t\tthis.currentgroupid = groupid;\n\t\t\t\tthis.lastupdate = 0;\n\t\t\t\tthis.words = [];\n\t\t\t\tthis.wordsrender = [];\n\t\t\t\tvar newurl = window.location.protocol + \"//\" + window.location.host + window.location.pathname + '?id='+this.cmid+'&g='+groupid;\n\t\t\t\twindow.history.replaceState({path:newurl},document.title,newurl);\n\t\t\t\tthis.update_wordcloud();\n\t\t\t}\n\t\t}\n\t    \n\t    switch_display(mod) {\n\t    \tif (this.displaymod == mod){\n\t\t\t\tif (mod == 'c') {\n\t\t\t\t\tif (this.editing) {\n\t\t\t\t\t\t//$('.wc_tools').show();\n\t\t\t\t\t}else{\n\t\t\t\t\t\t$('.wc_tools').hide();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\t    \tif (mod == 'f') {\n\t    \t\tthis.displaymod = 'f';\n\t    \t\tif ($('.wordcloudcontainer').is(':visible')) {\n        \t\t\t$('.wordcloudcontainer').hide();\n        \t\t}\n\t    \t\tif (this.editing) {\n\t    \t\t\t$('.wc_tools').hide();\n\t    \t\t}\n        \t\tif (!$('#wcform').is(':visible')) {\n        \t\t\t$('#wcform').show();\n        \t\t}\n\t    \t}else{\n\t    \t\tthis.displaymod = 'c';\n\t    \t\tif ($('#wcform').is(':visible')) {\n        \t\t\t$('#wcform').html('');\n        \t\t\t$('#wcform').hide();\n        \t\t}\n    \t\t\tif (!$('.wordcloudcontainer').is(':visible')) {\n        \t\t\t$('.wordcloudcontainer').show();\n        \t\t}\n    \t\t\tif (this.editing) {\n    \t\t\t\t$('.wc_tools').show();\n    \t\t\t}\t\n    \t\t}\n\t    }\n\t\t\n\t\tupdate_wordcloud(force=false) {\n\t\t\tif (!force && this.isediting){return;}\n\t\t\tif (this.lastupdate == undefined){\n\t\t\t\tthis.lastupdate = 0;\n\t\t\t}\n\t\t\t\n\t\t\tvar promises = ajax.call([\n\t            { methodname: 'mod_collabwordcloud_getdata', args: {\n\t\t\t\t\t\"cmid\": this.cmid,\n\t\t\t\t\t\"groupid\":this.currentgroupid,\n\t\t\t\t\t\"lastupdate\":this.lastupdate\n\t\t\t\t}},\n\t        ])\n\t\n\t        promises[0].done((function(response) {\n\t\t\t\tif (response.error==false) {\n            \t\tif (response.mod=='c') {\n\t            \t\tif (response.noupdate==true) {\n\t            \t\t\tthis.updatedelay = this.updatedelay+delaystep;\n\t            \t\t}else{\n\t            \t\t\tif (this.parent.find('.wc_participation').length) {\n\t            \t\t\t\tif (response.subs == 0) {\n\t            \t\t\t\t\tstr.get_string('nosubmition','mod_collabwordcloud').then((value)=>{ this.parent.find('.wc_participation_count').text(value); });\n\t            \t\t\t\t}else if (response.subs == 1) {\n\t            \t\t\t\t\tstr.get_string('onesubmition','mod_collabwordcloud',response.subs).then((value)=>{this.parent.find('.wc_participation_count').text(value);})\n\t            \t\t\t\t}else{\n\t            \t\t\t\t\tstr.get_string('multi_submition','mod_collabwordcloud',response.subs).then((value)=>{this.parent.find('.wc_participation_count').text(value);})\n\t            \t\t\t\t}\n\t            \t\t\t}\n\t            \t\t\tthis.updatedelay = delaystep;\n\t            \t\t\tthis.lastupdate = response.timemodified;\n\t\t\t\t\t\t\tthis.editing = response.editor;\n\t            \t\t\tthis.words = response.words;\n\t            \t\t\tthis.switch_display('c');\n\t            \t\t\tthis.update_svg();\n\t            \t\t\tif (this.words.length == 0){\n\t            \t\t\t\t$('.wc_empty').show();\n\t            \t\t\t}else{\n\t            \t\t\t\t$('.wc_empty').hide();\n\t            \t\t\t}\n\t            \t\t}\n\t\t    \t\t\tif (this.updatetimer != undefined){\n\t\t    \t\t\t\tclearTimeout(this.updatetimer);\n\t\t    \t\t\t}\n\t\t    \t\t\tif (this.updatedelay < maxdelay) {\n\t\t    \t\t\t\tthis.updatetimer = setTimeout((function(){this.update_wordcloud();}).bind(this),this.updatedelay);\n\t\t    \t\t\t}\n            \t\t}else{\n            \t\t\tthis.switch_display('f');\n            \t\t\t$('#wcform').html(response.form);\n            \t\t}\n            \t}\n\t\t\t}).bind(this));\n\t\t}\n\t\t\n\t\texportPNG() {\n\t\t    var t = document.createElement(\"canvas\")\n\t\t      , e = t.getContext(\"2d\");\n\t\t    t.width = this.width,\n\t\t    t.height = this.height,\n\t\t    e.translate(this.width >> 1, this.height >> 1),\n\t\t    this.wordsrender.forEach(function(t, n) {\n\t\t        e.save(),\n\t\t        e.translate(t.x, t.y),\n\t\t        e.rotate(t.rotate * Math.PI / 180),\n\t\t        e.textAlign = \"center\",\n\t\t        e.fillStyle = fill(t.text.toLowerCase()),\n\t\t        e.font = t.size + \"px \" + t.font,\n\t\t        e.fillText(t.text, 0, 0),\n\t\t        e.restore()\n\t\t    });\n\t\t    var a = document.createElement(\"a\");\n\t\t    a.href = t.toDataURL(\"image/png\").replace(\"image/png\", \"image/octet-stream\");\n\t\t    a.download = \"export.png\";\n\t\t    a.click();\n\t\t}\n\t\t\n\t\texportData() {\n\t\t\tvar promises = ajax.call([\n\t            { methodname: 'mod_collabwordcloud_exportdata', args: {\n\t\t\t\t\t\"cmid\": this.cmid,\n\t\t\t\t\t\"groupid\":this.currentgroupid\n\t\t\t\t}},\n\t        ])\n\t\n\t        promises[0].done(function(response) {\n\t\t\t\tif (response.error==false) {\n            \t\tvar a = document.createElement('a');\n            \t\tif (window.URL && window.Blob && ('download' in a) && window.atob) {\n            \t\t    var blob = base64ToBlob(response.data, 'text/octet-stream');\n            \t\t    var url = window.URL.createObjectURL(blob);\n            \t\t    a.href = url;\n            \t\t    a.download = 'export.csv';\n            \t\t    a.click();\n            \t\t    window.URL.revokeObjectURL(url);\n            \t\t}\n            \t}\n\t\t\t});\n\t\t}\n\t\t\n\t\taddWord() {\n\t\t\t$(this.parent).find('input[name=\"wcaddword\"]').prop(\"disabled\",true);\n\t\t\t$(this.parent).find('.wc_addword').prop(\"disabled\",true);\n\t\t\tvar word = $(this.parent).find('input[name=\"wcaddword\"]').val();\n\t\t\t\n\t\t\tvar promises = ajax.call([\n\t            { methodname: 'mod_collabwordcloud_addword', args: {\n\t\t\t\t\t\"cmid\": this.cmid,\n\t\t\t\t\t\"groupid\":this.currentgroupid,\n\t\t\t\t\t\"word\":word\n\t\t\t\t}},\n\t        ])\n\t\n\t        promises[0].done((function(response) {\n\t\t\t\tif (response.error==false) {\n            \t\tthis.update_wordcloud();\n            \t}\n            \t$(this.parent).find('input[name=\"wcaddword\"]').prop(\"disabled\",false);\n    \t\t\t$(this.parent).find('.wc_addword').prop(\"disabled\",false);\n    \t\t\t$(this.parent).find('input[name=\"wcaddword\"]').val('');\n    \t\t\t$(this.parent).find('input[name=\"wcaddword\"]').focus();\n\t\t\t}).bind(this))\n\t\t\t.fail((function(data) {\n\t\t\t\t$(this.parent).find('input[name=\"wcaddword\"]').prop(\"disabled\",false);\n    \t\t\t$(this.parent).find('.wc_addword').prop(\"disabled\",false);\n    \t\t\t$(this.parent).find('input[name=\"wcaddword\"]').val('');\n    \t\t\t$(this.parent).find('input[name=\"wcaddword\"]').focus();\n\t\t\t}).bind(this));\n\t\t}\n\t\t\n\t\tloadWordEdit(word) {\n\t\t\tthis.isediting = true;\n\t\t\tthis.editingword = word;\n\t\t\t$(this.selector).addClass('locked');\n\t\t\t$(\"#updateword_fusion_warn\").hide();\n\t\t\tthis.parent.find('.wc_groupselector').prop('disabled', true);\n\t\t\t\n\t\t\tvar promises = ajax.call([\n\t            { methodname: 'mod_collabwordcloud_getwordinfo', args: {\n\t\t\t\t\t\"cmid\": this.cmid,\n\t\t\t\t\t\"groupid\":this.currentgroupid,\n\t\t\t\t\t\"word\":word\n\t\t\t\t}},\n\t        ])\n\t\n\t        promises[0].done((function(response) {\n\t\t\t\tif (response.error==false) {\n            \t\tthis.weight = response.weight;\n            \t\tthis.parent.find('input[name=wceditword]').val(response.word);\n            \t\tthis.parent.find('.wc_weight span').text(response.weight);\n            \t\t\n            \t\tvar ul = this.parent.find('.wc_users ul');\n            \t\tul.html('');\n            \t\t\n            \t\t$(response.users).each(function(idx,val){\n            \t\t\tul.append('<li>'+val+'</li>');\n            \t\t});\n            \t\t\n            \t\tif ( this.parent.find('.wc_editor_word').is(\":hidden\") ) {\n            \t\t\tthis.parent.find('.wc_tools').slideUp(500);\n            \t\t\tthis.parent.find('.wc_editor_word').slideDown(500);\n            \t\t}\n            \t\t\n            \t}\n\t\t\t}).bind(this));\n\t\t}\n\t\t\n\t\tcloseWordEdit() {\n\t\t\tthis.isediting = false;\n\t\t\tthis.editingword = '';\n    \t\tthis.parent.find('input[name=wceditword]').val('');\n    \t\tthis.parent.find('.wc_weight span').text('');\n    \t\t\n    \t\tvar ul = this.parent.find('.wc_users ul');\n    \t\tul.html('');\n    \t\t\n    \t\tthis.parent.find('.wc_tools').slideDown(500);\n    \t\tthis.parent.find('.wc_editor_word').slideUp(500);\n    \t\t$(this.selector).removeClass('locked');\n    \t\tthis.parent.find('.wc_groupselector').prop('disabled', false);\n\t\t}\n\t\t\n\t\tupdateWord() {\n\t\t\tvar newword = this.parent.find('input[name=wceditword]').val();\n\n            newword = newword.replaceAll('\\\\','').replaceAll('\"','');\n            this.parent.find('input[name=wceditword]').val(newword);\n\t\t\t\n\t\t\tvar promises = ajax.call([\n\t            { methodname: 'mod_collabwordcloud_updateword', args: {\n\t\t\t\t\t\"cmid\": this.cmid,\n\t\t\t\t\t\"groupid\":this.currentgroupid,\n\t\t\t\t\t\"word\":this.editingword,\n\t\t\t\t\t\"newword\":newword\n\t\t\t\t}},\n\t        ])\n\t\n\t        promises[0].done((function (response) {\n\t\t\t\tthis.lastupdate=0;\n\t\t\t\tthis.update_wordcloud(true);\n\t\t\t\tthis.closeWordEdit();\n            }).bind(this));\n\t\t}\n\t\t\n\t\tsimUpdateWord() {\n\t\t\tvar newword = this.parent.find('input[name=wceditword]').val();\n\t\t\t\n\t\t\tif (this.editingword == newword) {\n\t\t\t\t$(\"#updateword_fusion_warn\").hide();\n\t\t\t\tthis.parent.find('.wc_weight span').text(this.weight);\n\t\t\t}else{\n\t\t\t\tvar promises = ajax.call([\n\t\t            { methodname: 'mod_collabwordcloud_simupdateword', args: {\n\t\t\t\t\t\t\"cmid\": this.cmid,\n\t\t\t\t\t\t\"groupid\":this.currentgroupid,\n\t\t\t\t\t\t\"word\":this.editingword,\n\t\t\t\t\t\t\"newword\":newword\n\t\t\t\t\t}},\n\t\t        ])\n\t\t\n\t\t        promises[0].done((function (response) {\n\t\t\t\t\tif (response.error==false) {\n\t            \t\tif (response.fusion){\n\t            \t\t\t$(\"#updateword_fusion_warn\").show();\n\t            \t\t\tthis.parent.find('.wc_weight span').text(\"\"+response.subs+\" (valeur actuelle : \"+this.weight+\")\");\n\t            \t\t}else{\n\t            \t\t\t$(\"#updateword_fusion_warn\").hide();\n\t            \t\t\tthis.parent.find('.wc_weight span').text(this.weight);\n\t            \t\t}\n\t            \t}\n\t\t\t\t}).bind(this));\n\t\t\t}\n\t\t}\n\t\t\n\t\tremoveWord() {\n\t\t\tvar promises = ajax.call([\n\t            { methodname: 'mod_collabwordcloud_removeword', args: {\n\t\t\t\t\t\"cmid\": this.cmid,\n\t\t\t\t\t\"groupid\":this.currentgroupid,\n\t\t\t\t\t\"word\":this.editingword\n\t\t\t\t}},\n\t        ])\n\t\n\t        promises[0].done((function (response) {\n\t\t\t\tif (response.error==false) {\n            \t\tthis.lastupdate=0;\n            \t\tthis.update_wordcloud();\n            \t}\n\t\t\t}).bind(this));\n\t\t}\n\t}\n\t\n\tfunction base64ToBlob(base64, mimetype, slicesize) {\n\t    if (!window.atob || !window.Uint8Array) {\n\t        return null;\n\t    }\n\t    mimetype = mimetype || '';\n\t    slicesize = slicesize || 512;\n\t    var bytechars = atob(base64);\n\t    var bytearrays = [];\n\t    for (var offset = 0; offset < bytechars.length; offset += slicesize) {\n\t        var slice = bytechars.slice(offset, offset + slicesize);\n\t        var bytenums = new Array(slice.length);\n\t        for (var i = 0; i < slice.length; i++) {\n\t            bytenums[i] = slice.charCodeAt(i);\n\t        }\n\t        var bytearray = new Uint8Array(bytenums);\n\t        bytearrays[bytearrays.length] = bytearray;\n\t    }\n\t    return new Blob(bytearrays, {type: mimetype});\n\t};\n\t\n\treturn {\n\t\tshowWordcloud : function(cmid,selector, apiurl, editor){\n        \tshowWordcloud(cmid, selector, apiurl, editor);\n        }\n    };\n});\n"],"names":["define","$","ajax","str","wordclouds","fill","d3","scaleOrdinal","schemeCategory10","showWordcloud","cmid","selector","api_url","editor","wordCloud","width","_selector","height","displaymod","parent","editing","isediting","editingword","simtimer","resizetimer","updatetimer","updatedelay","lastupdate","words","wordsrender","wcwidth","this","parents","borderwidth","weight","currentgroupid","svg","select","append","attr","length","switch_display","find","changegroup","val","listeners","on","bind","window","resize","undefined","clearTimeout","setTimeout","split","exportPNG","exportData","addWord","e","which","click","event","loadWordEdit","target","text","simUpdateWord","updateWord","removeWord","closeWordEdit","cloud","selectAll","data","d","enter","style","i","Math","random","transition","duration","size","x","y","rotate","exit","remove","JSON","parse","stringify","layout","padding","font","fontSize","draw","start","update_svg","groupid","newurl","location","protocol","host","pathname","history","replaceState","path","document","title","update_wordcloud","mod","is","hide","show","html","force","promises","call","methodname","args","done","response","error","noupdate","subs","get_string","then","value","_this","timemodified","form","t","createElement","getContext","translate","forEach","n","save","PI","textAlign","fillStyle","toLowerCase","fillText","restore","a","href","toDataURL","replace","download","URL","Blob","atob","blob","base64","mimetype","slicesize","Uint8Array","bytechars","bytearrays","offset","slice","bytenums","Array","charCodeAt","bytearray","type","base64ToBlob","url","createObjectURL","revokeObjectURL","prop","word","focus","fail","addClass","ul","users","each","idx","slideUp","slideDown","removeClass","newword","replaceAll","fusion","apiurl"],"mappings":"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"}
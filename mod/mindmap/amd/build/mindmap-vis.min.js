define(["jquery","mod_mindmap/mindmap"],function(a,b){return{Init:function(c,d,e,f){function g(){document.getElementById("savebutton").onclick=null,document.getElementById("cancelbutton").onclick=null,document.getElementById("network-popup").style.display="none"}function h(a){g(),a(null)}function i(a,b){a.id=document.getElementById("node-id").value,a.label=document.getElementById("node-label").value,a.shape=document.getElementById("node-shape").value,a.font.color=document.getElementById("node-font-color").value,a.color.background=document.getElementById("node-color-background").value,g(),b(a)}function j(a){var b=[];return a.forEach(function(a,c,d){b.push({id:a.id,label:a.label,shape:a.hasOwnProperty("shape")?a.shape:"box",x:a.x,y:a.y,font:{color:a.hasOwnProperty("font")?a.font.color:"#343434"},color:{background:a.hasOwnProperty("color")?a.color.background:"#97c1fc"},widthConstraint:{maximum:300},margin:10})}),new vis.DataSet(b)}function k(a,b){for(var c=0;c<a.length;c++)if(a[c].id==b)return a[c];throw"Can not find id '"+b+"' in data"}function l(a){var b=[];return a.forEach(function(c){c.connections.forEach(function(d,e,f){b.push({from:c.id,to:d,width:2});var g=k(a,d),h=g.connections,i=h.filter(function(a){return a==c.id})[0];i!=-1&&h.splice(i,1)})}),new vis.DataSet(b)}function m(a){return Object.keys(a).map(function(b){return a[b].id=b,a[b]})}function n(a,b){a.connections=u.getConnectedNodes(a.id)}function o(a,b){a.label=u.body.nodes[a.id].options.label,u.body.nodes[a.id].options.hasOwnProperty("shape")&&(a.shape=u.body.nodes[a.id].options.shape),u.body.nodes[a.id].options.font.hasOwnProperty("color")&&(a.font={},a.font.color=u.body.nodes[a.id].options.font.color),u.body.nodes[a.id].options.color.hasOwnProperty("background")&&(a.color={},a.color.background=u.body.nodes[a.id].options.color.background)}function p(){var a=m(u.getPositions());a.forEach(o),a.forEach(n);var d=JSON.stringify(a,void 0,2),e=new b;e.mindmapsubmit(c,d)}var q;a.ajax({async:!1,url:"mindmapdata.php?id="+c,success:function(a){q=a}});var r={custom:{edit:f.visjsedit,del:f.visjsdel,back:f.visjsback,addNode:f.visjsaddnode,addEdge:f.visjsaddedge,editNode:f.visjseditnode,editEdge:f.visjseditedge,addDescription:f.visjsadddescription,edgeDescription:f.visjsedgedescription,editEdgeDescription:f.visjseditedgedescription,createEdgeError:f.visjscreateedgeerror,deleteClusterError:f.visjsdeleteclustererror,editClusterError:f.visjseditclustererror}},s=[{id:"moodle",label:"Moodle",x:400,y:370,font:{color:"#ffffff",size:18},color:{background:"#ff0000"},widthConstraint:{maximum:300},margin:10,borderWidth:1,shape:"box",labelHighlightBold:!1}],t=[],u=null,v=q;if(v.length>0)var w=JSON.parse(v),x={nodes:j(w),edges:l(w)};else var x={nodes:s,edges:t};var y=document.querySelector(".network"),z={};0==d?(z={manipulation:{initiallyActive:!0,addNode:function(a,b){document.getElementById("operation").innerHTML=f.visjsaddnode,document.getElementById("node-id").value=a.id,document.getElementById("node-label").value="",document.getElementById("node-font-color").value="#343434",document.getElementById("node-color-background").value="#97c1fc",document.getElementById("node-shape").value="box";var c={id:document.getElementById("node-id").value,x:a.x,y:a.y,label:document.getElementById("node-label").value,shape:document.getElementById("node-shape").value,font:{color:document.getElementById("node-font-color").value},color:{background:document.getElementById("node-color-background").value}};document.getElementById("savebutton").onclick=i.bind(this,c,b),document.getElementById("cancelbutton").onclick=g.bind(),document.getElementById("network-popup").style.display="block"},editNode:function(a,b){document.getElementById("operation").innerHTML=f.visjseditnode,document.getElementById("node-id").value=a.id,document.getElementById("node-label").value=a.label,document.getElementById("node-font-color").value=a.font.hasOwnProperty("color")?a.font.color:"#343434",document.getElementById("node-color-background").value=a.color.hasOwnProperty("background")?a.color.background:"#97c1fc",document.getElementById("node-shape").value=a.hasOwnProperty("shape")?a.shape:"box",document.getElementById("savebutton").onclick=i.bind(this,a,b),document.getElementById("cancelbutton").onclick=h.bind(this,b),document.getElementById("network-popup").style.display="block"},addEdge:function(a,b){if(a.from==a.to){var c=confirm("Do you want to connect the node to itself?");1==c&&b(a)}else b(a)}},physics:{enabled:!1},edges:{physics:!1,dashes:!1,smooth:{enabled:!1},width:2},nodes:{borderWidth:1,shape:"box",widthConstraint:{maximum:300},margin:10,font:{size:18},labelHighlightBold:!1}},a("#export_button").on("click",function(){p()})):z={physics:{enabled:!1},edges:{physics:!1,dashes:!1,smooth:{enabled:!1},width:2},nodes:{borderWidth:1,shape:"box",widthConstraint:{maximum:300},margin:10,font:{size:18},labelHighlightBold:!1}},z.locales=r,z.locale="custom",u=new vis.Network(y,x,z),u.on("zoom",function(){pos=[],pos=u.getViewPosition(),u.getScale()<=.49&&u.moveTo({position:{x:pos.x,y:pos.y},scale:.49}),u.getScale()>=5.49&&u.moveTo({position:{x:pos.x,y:pos.y},scale:5.49})}),a(".resetzoom").on("click",function(){u.fit()}),0==d&&(u.on("doubleClick",function(a){a.edges.length>=0&&a.nodes.length>0?u.editNode():a.edges.length>0&&0==a.nodes.length?u.editEdgeMode():0==a.edges.length&&0==a.nodes.length&&u.addEdgeMode()}),a("html").keyup(function(a){"Insert"==a.key&&u.addNodeMode(),"Delete"==a.key&&u.deleteSelected()}))}}});